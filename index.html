<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EU Macro</title>
<style>
:root{--base-font:10px}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#eef;color:#111;text-align:center}
h1{margin:8px 0;font-size:20px}
#controls{padding:8px}
select{padding:9px 12px;font-size:12px;border-radius:6px;border:1px solid #bbb;background:#fff;margin-right:6px}
#mapWrap{position:relative;width:95%;max-width:1100px;margin:12px auto}
#mapImg{display:block;width:100%;height:auto}
.pin{position:absolute;transform:translate(-50%,-50%);white-space:nowrap;display:flex;flex-direction:column;align-items:center;padding:4px 6px;border-radius:4px;background:rgba(255,255,255,0.65);box-shadow:0 1px 2px rgba(0,0,0,.12);pointer-events:auto;text-align:center}
.pin img{width:18px;height:12px;display:inline-block;margin-bottom:2px}
#status{font-size:11px;color:#555;margin-top:5px}
#source{font-size:10px;color:#555;margin:6px auto;max-width:800px;}
#source a{color:#2b7cff;text-decoration:none;}
</style>
</head>
<body>

<h1>EU Macro</h1>

<div id="controls">
<select id="stat">
  <option value="">Select KPI…</option>
  <option value="GDP">GDP (US$B)</option>
  <option value="GDPpc">GDP per capita (US$)</option>
  <option value="Infl">Inflation (%)</option>
  <option value="Unemp">Unemployment (%)</option>
</select>
<select id="year">
  <option>–</option>
</select>
</div>

<div id="mapWrap">
<img id="mapImg" src="https://raw.githubusercontent.com/aceg-pl/tr/main/Europe.png" alt="Europe map">
</div>

<div id="source">
  Data source: <a href="https://data.worldbank.org/" target="_blank">World Bank</a>
</div>

<div id="status">Ready.</div>

<script>
const PLACES=[{cc:'pt',code:'PT',x:7,y:83},{cc:'es',code:'ES',x:16,y:85},{cc:'fr',code:'FR',x:27,y:69},{cc:'be',code:'BE',x:30,y:62.5},{cc:'nl',code:'NL',x:32,y:57},{cc:'ie',code:'IE',x:15,y:51},{cc:'gb',code:'UK',x:22,y:55},{cc:'dk',code:'DK',x:36.5,y:48},{cc:'de',code:'DE',x:37.5,y:60},{cc:'ch',code:'CH',x:35,y:71},{cc:'at',code:'AT',x:42,y:69},{cc:'se',code:'SE',x:42.5,y:32},{cc:'no',code:'NO',x:39.5,y:26},{cc:'fi',code:'FI',x:54,y:27},{cc:'ee',code:'EE',x:55.5,y:40},{cc:'lv',code:'LV',x:55,y:44},{cc:'lt',code:'LT',x:54,y:48.5},{cc:'pl',code:'PL',x:49.5,y:57},{cc:'cz',code:'CZ',x:44,y:63},{cc:'sk',code:'SK',x:52,y:66},{cc:'hu',code:'HU',x:51,y:69.5},{cc:'si',code:'SI',x:45,y:73},{cc:'hr',code:'HR',x:45,y:76},{cc:'rs',code:'RS',x:54,y:74.5},{cc:'ro',code:'RO',x:59.5,y:70.5},{cc:'bg',code:'BG',x:61,y:78},{cc:'gr',code:'GR',x:56,y:88},{cc:'it',code:'IT',x:39.5,y:79.5}];
const flagURL=c=>`https://flagcdn.com/24x18/${c.toLowerCase()}.png`;
const mapWrap=document.getElementById('mapWrap'),img=document.getElementById('mapImg'),status=document.getElementById('status');
const statSelect=document.getElementById('stat'),yearSelect=document.getElementById('year');
const WB_IND={GDP:'NY.GDP.MKTP.CD',GDPpc:'NY.GDP.PCAP.CD',Infl:'FP.CPI.TOTL.ZG',Unemp:'SL.UEM.TOTL.ZS'};

function placePin(p,val,color){
  const imgRect=img.getBoundingClientRect();
  const el=document.createElement('div');el.className='pin';
  el.style.left=Math.round(p.x/100*imgRect.width)+'px';
  el.style.top=Math.round(p.y/100*imgRect.height)+'px';
  el.style.background=color;
  el.innerHTML=`<div><img src="${flagURL(p.cc)}" alt="${p.code}"><strong>${p.code}</strong></div><div>${val}</div>`;
  mapWrap.appendChild(el);return el;
}

function scalePins(){
  const w=img.clientWidth;const base=Math.max(10,Math.round(w/60));
  mapWrap.querySelectorAll('.pin').forEach(p=>{
    p.style.fontSize=base+'px';
    const imgTag=p.querySelector('img');
    if(imgTag){imgTag.style.width=Math.max(12,Math.round(base*1.2))+'px';
    imgTag.style.height=Math.max(8,Math.round(base*0.8))+'px';}
  });
}

function fmt(v,stat){
  if(v==null||v==='?') return '–';
  if(stat==='GDP') return (v/1e9).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,".") + 'B';
  if(stat==='GDPpc') return Math.round(v).toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");
  if(stat==='Infl'||stat==='Unemp') return (Math.round(v*10)/10)+'%';
  return v;
}

function trendArrow(lat,prev){
  if(lat==null||prev==null)return'';
  const a=Number(lat),b=Number(prev);if(isNaN(a)||isNaN(b))return'';
  return Math.abs(a-b)<=Math.abs(b)*0.005?' →':a>b?'⬆️':'⬇️';
}

function colorScale(val,min,max,reverse=false){
  if(val==null)return'rgba(200,200,200,0.6)';
  let t=(val-min)/(max-min); t=Math.max(0, Math.min(1, t));
  if(reverse) t=1-t;
  const h=120*(1-t);
  const s=50+10*t;
  const l=65-15*t;
  return `hsl(${h},${s}%,${l}%)`;
}

async function wbFetch(cc,indicator){
  try{
    const r=await fetch(`https://api.worldbank.org/v2/country/${cc.toLowerCase()}/indicator/${indicator}?format=json&per_page=6&date=2000:2025`);
    const j=await r.json();
    const data=j[1].filter(d=>d.value!==null);
    if(!data.length)return[];
    return data.slice(0,4);
  }catch(e){return[];}
}

async function loadYears(){
  const sample=PLACES[0];
  const data=await wbFetch(sample.code,WB_IND[statSelect.value]);
  yearSelect.innerHTML='';
  if(!data.length) {yearSelect.innerHTML=`<option>–</option>`; return;}
  yearSelect.innerHTML=`<option value="0">Latest</option>`;
  for(let i=1;i<data.length;i++){yearSelect.innerHTML+=`<option value="${i}">Period -${i}</option>`;}
}

function updateTitle(allData){
  const period = parseInt(yearSelect.value);
  let year = '–';
  if(allData && Object.keys(allData).length){
    for(const c in allData){
      const d = allData[c][period];
      if(d && d.date) { year = d.date; break; }
    }
  }
  document.title = `EU Macro — ${year}`;
  document.querySelector('h1').textContent = `EU Macro (${year})`;
}

async function showStat(){
  if(!statSelect.value) return;
  document.querySelectorAll('.pin').forEach(n=>n.remove());
  const statKey=statSelect.value;
  const period=parseInt(yearSelect.value);
  status.textContent=`Loading ${statKey}...`;
  const vals=[];const allData={};
  for(const p of PLACES){const d=await wbFetch(p.code,WB_IND[statKey]);allData[p.code]=d;const r=d[period]||{};vals.push(r.value);}
  const min=Math.min(...vals.filter(v=>v!=null)),max=Math.max(...vals.filter(v=>v!=null));
  for(const
